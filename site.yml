---
# Master site playbook - runs all configuration in correct order
# Usage: ansible-playbook -i inventories/homelab.ini site.yml

- name: "=== HOMELAB SETUP: Complete System Configuration ==="
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display setup information
      debug:
        msg:
          - "========================================="
          - "üè† HOMELAB COMPLETE SETUP"
          - "========================================="
          - ""
          - "This will configure your system with:"
          - "  ‚úì OS updates and essential packages"
          - "  ‚úì SSH security hardening"
          - "  ‚úì Docker container runtime"
          - "  ‚úì Kubernetes (MicroK8s) platform"
          - "  ‚úì Platform management tools (kubectl, helm)"
          - "  ‚úì User accounts and permissions"
          - "  ‚úì System optimization for containers"
          - ""
          - "Target hosts: {{ groups['homelab'] | join(', ') }}"
          - ""
          - "‚è±Ô∏è  Total estimated time: 15-20 minutes"
          - "üöÄ Starting in 5 seconds..."

    - name: Pause before starting
      pause:
        seconds: 5

# Phase 1: OS Foundation
- name: "Phase 1/7: üîÑ System Updates & Essential Packages"
  import_playbook: playbooks/update_os.yml

- name: "Phase 2/7: üîê SSH Security Configuration"
  import_playbook: playbooks/configure_ssh.yml

# Phase 2: Container Platform
- name: "Phase 3/7: üê≥ Docker Installation"
  import_playbook: playbooks/install_docker.yml

- name: "Phase 4/7: ‚ò∏Ô∏è  Kubernetes (MicroK8s) Setup"
  import_playbook: playbooks/install_kubernetes.yml

# Phase 3: Platform Tools
- name: "Phase 5/7: üõ†Ô∏è  Platform Tools Installation"
  import_playbook: playbooks/install_platform_tools.yml

- name: "Phase 6/7: üë• User Account Setup"
  import_playbook: playbooks/setup_users.yml

- name: "Phase 7/7: ‚öôÔ∏è  System Configuration & Optimization"
  import_playbook: playbooks/configure_systems.yml

# Final Summary
- name: "=== SETUP COMPLETE: Summary and Next Steps ==="
  hosts: all
  gather_facts: true
  tasks:
    - name: Gather final system state
      setup:

    - name: Check Docker status
      command: docker --version
      register: docker_version
      changed_when: false

    - name: Check MicroK8s status
      command: microk8s status --wait-ready --timeout 30
      register: microk8s_status
      changed_when: false
      become: true

    - name: Check platform tools
      shell: "{{ item }} --version 2>/dev/null || echo 'Not found'"
      loop:
        - kubectl
        - helm
      register: tool_versions
      changed_when: false

    - name: Display completion summary
      debug:
        msg:
          - "==========================================="
          - "üéâ HOMELAB SETUP COMPLETED SUCCESSFULLY!"
          - "==========================================="
          - ""
          - "üìä System Summary:"
          - "  Host: {{ inventory_hostname }}"
          - "  OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "  Kernel: {{ ansible_kernel }}"
          - "  Memory: {{ ansible_memtotal_mb }}MB"
          - "  Architecture: {{ ansible_architecture }}"
          - ""
          - "üîß Installed Software:"
          - "  Docker: {{ docker_version.stdout }}"
          - "  MicroK8s: Ready"
          - "  Users: davidg, labuser (both with sudo/docker/k8s access)"
          - ""
          - "üöÄ Next Steps:"
          - "  1. Log out and back in to activate group memberships"
          - "  2. Test Docker: docker run hello-world"
          - "  3. Test Kubernetes: kubectl get nodes"
          - "  4. Deploy containerized development environments"
          - ""
          - "üìÅ Platform Directories:"
          - "  ~/manifests - Kubernetes manifests"
          - "  ~/charts - Helm charts"
          - ""
          - "üéØ Your platform is ready to host containerized workloads!"

    - name: Display platform tools summary
      debug:
        msg: "{{ item.item }}: {{ item.stdout | regex_replace('\\n.*', '') }}"
      loop: "{{ tool_versions.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Create setup completion marker
      copy:
        content: |
          HOMELAB SETUP COMPLETED
          ======================

          Setup completed: {{ ansible_date_time.iso8601 }}
          Host: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}

          Installed Components:
          - Docker CE: {{ docker_version.stdout }}
          - MicroK8s with DNS and storage addons
          - Platform tools: kubectl, helm
          - Essential utilities for container management
          - Users: davidg, labuser (both with full access)

          System Configuration:
          - SSH key-only authentication
          - Passwordless sudo
          - Container-optimized settings
          - Development environment ready

          Next steps:
          1. Log out/in to activate group memberships
          2. Test Docker and Kubernetes
          3. Deploy containerized development environments

          For cluster setup, add this node to your Kubernetes cluster
          or configure additional homelab services.
        dest: /etc/homelab-setup-complete
        mode: '0644'
      become: true
